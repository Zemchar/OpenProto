{% extends 'Base.html' %}
{% block curDisplay %}
{% if currentDisplay %}
Displaying: {{ currentDisplay }}
{% else %}
Displaying: Nothing
{% endif %}
{% endblock %}
{% block title %}Upload File{% endblock %}

{% block content %}


<style>
    @media (min-width: 768px) {
        #content {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: #f3f3f3;
        }

        .wrapper {
            width: 500px;
        }
    }

    @media (max-width: 767px) {
        #content {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 10px;
            background: #f3f3f3;
        }

        .wrapper {
            width: 100%;
        }
    }

    .upload-area {
        width: 100%;
        height: 300px;
        border: 2px dashed #999999;
        align-items: center;
        justify-content: center;
        display: flex;
        text-align: center;
        border-radius: 15px;
        background-repeat: no-repeat;
        background-size: cover;
        background-position: center;
        margin-bottom: 10px;
    }

    .upload-area img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .upload-area:hover {
        cursor: pointer;
        background: #F6F6F6;
    }

    .rename-file {
        padding-top: 20px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 1em;
    }

    .rename-file input, .rename-file button {
        height: 40px;
        width: 100%;
        text-align: center;
        border-radius: 20px;
        font-size: 16px;
        padding: 0 10px;
        margin-bottom: 10px;
    }

    .rename-file input {
        border: 1px solid #cecece;
    }

</style>
<div class="wrapper">

    <div class="upload-area" id="uploadfile">
        <h1>Drag and Drop file here<br/>Or<br/>Click to select file</h1>
    </div>
    <div class="rename-file">
        <input type="text" id="filename" name="filename" placeholder="Enter new file name">
        <button onclick="uploadFile()" id="submit-button">Upload File</button>
    </div>
</div>
<script>
    let uploadArea = document.getElementById('uploadfile');

    // Event listeners for drag and drop
    uploadArea.addEventListener('dragenter', (event) => {
        event.stopPropagation();
        event.preventDefault();
    }, false);

    uploadArea.addEventListener('dragover', (event) => {
        event.stopPropagation();
        event.preventDefault();
    }, false);

    uploadArea.addEventListener('drop', (event) => {
        event.stopPropagation();
        event.preventDefault();

        let dt = event.dataTransfer;
        let files = dt.files;

        handleFiles(files);
    }, false);

    // Open file selector on div click
    // Create input element
    let fileInput = document.createElement('input');
    fileInput.type = 'file';

    uploadArea.addEventListener('click', (event) => {
        fileInput.click();
    });

    fileInput.addEventListener('change', (event) => {
        handleFiles(event.target.files);
    });

    document.getElementById('file-input').addEventListener('change', (event) => {
        handleFiles(event.target.files);
    });

    function handleFiles(files) {
        const file = files[0];


        // Check if the file is an image.
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();

            reader.onloadend = function (event) {
                // Replace the drop area contents with the uploaded image
                uploadArea.innerHTML = '';
                let img = document.createElement('img');
                img.src = event.target.result;
                uploadArea.appendChild(img);
                document.querySelector("#filename").value = file.name
            };

            reader.readAsDataURL(file);
        } else {
            showToast("Accepted file types are: .jpg, .png, .gif", "error")
        }
    }

    function uploadFile() {
        // Get the selected file
        let file = uploadArea.querySelector('img').src;
        let formData = new FormData();

        // Fetch the image data and blob it
        fetch(file)
            .then(res => res.blob())
            .then(blob => {
                // Append the blob to FormData
                formData.append('file', blob, 'filename');

                // Check if a new name has been specified
                let newName = document.querySelector('#filename').value;
                if (newName !== '') {
                    formData.set('file', blob, newName);
                }

                // Send the POST request to the server
                $.ajax({
                    type: "POST",
                    url: $(location).attr('href'),
                    data: formData,
                    processData: false,
                    contentType: false, // the request must include this line to correctly send a file
                }).done((response) => {
                    showToast(`File Upload Complete`, response)
                })
            })
    }

</script>

{% endblock %}